<!DOCTYPE html>
<!-- 

         \\
          \\_   \\
           (')   \\_
   jgs    / )=.- -(')
        o( )o( )_-\_

 http://danielhaehn.com
 
 email me!   h a e h n <AT> i e e e . o r g

 PZ.

 -->
<html>
  <head>
    <title>Threaded Tornado – DANIELHAEHN.com</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content=" The Tornado webserver is an awesome web framework for Python. Unfortunately, configuring it for asynchronous requests can get quite confusing.

Here is a simple and minimal example, John and I created.

" />
    <meta property="og:description" content=" The Tornado webserver is an awesome web framework for Python. Unfortunately, configuring it for asynchronous requests can get quite confusing.

Here is a simple and minimal example, John and I created.

" />
    
    <meta name="author" content="" />

    
    <meta property="og:title" content="Threaded Tornado" />
    <meta property="twitter:title" content="Threaded Tornado" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title=" - " href="/feed.xml" />

  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/"><img src="/gfx/danielhaehncom.png" title="DANIELHAEHN.com"/></a>

          <nav>
            <a href="/posts">Posts</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Threaded Tornado</h1>

  <div class="entry">
    <p><img src="/gfx/posts/tornado_small.png" alt="Tornado Webserver" title="Tornado Webserver" class="thumb underlay" /> The <a href="http://www.tornadoweb.org/">Tornado webserver</a> is an awesome web framework for Python. Unfortunately, configuring it for asynchronous requests can get quite confusing.</p>

<p>Here is a simple and minimal example, <a href="http://blog.hoff.in">John</a> and I created. <!-- more --> It was inspired by several other examples, such as <a href="http://www.tornadoweb.org/en/stable/guide/async.html">the official documentation</a>, <a href="http://www.tornadoweb.org/en/stable/faq.html">the official faq</a> and <a href="ask john">this GIST</a>.</p>

<p>The main component is the following decorated <code class="highlighter-rouge">@tornado.gen.coroutine</code>-skeleton:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="nd">@tornado.gen.coroutine</span>
<span class="k">def</span> <span class="nf">SOME_HANDLER</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="c"># we need a ThreadPoolExecutor!</span>
  <span class="n">SOME_RESULT</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">EXECUTOR</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">SOME_OTHER_FUNCTION</span><span class="p">,</span>
                                      <span class="n">SOME_ARGUMENT_1</span><span class="o">=</span><span class="n">SOME_VALUE</span><span class="p">,</span>
                                      <span class="n">SOME_ARGUMENT_2</span><span class="o">=</span><span class="n">ANOTHER_VALUE</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SOME_RESULT</span><span class="p">)</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">EXECUTOR</code> is a <code class="highlighter-rouge">ThreadPoolExecutor</code> - coming from the <a href="https://docs.python.org/3/library/concurrent.futures.html">future</a>! By using this skeleton, <code class="highlighter-rouge">SOME_OTHER_FUNCTION</code> gets called in a <em>non-blocking</em> way (which is the whole point).</p>

<p>Below is a full example which sets up tornado on port 8888. As soon as a client connects, an external <code class="highlighter-rouge">Core</code> instance handles the request and artificially sleeps for ten seconds. During this sleep, nothing is blocked.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">tornado</span>
<span class="kn">import</span> <span class="nn">tornado.gen</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span> <span class="c"># pip install futures</span>



<span class="k">class</span> <span class="nc">Core</span><span class="p">():</span>
  <span class="s">'''
  The core can be anything outside of tornado!
  '''</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">):</span>

    <span class="k">print</span> <span class="s">'going to sleep'</span><span class="p">,</span> <span class="n">remote_ip</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'done sleeping'</span><span class="p">,</span> <span class="n">remote_ip</span>

    <span class="k">return</span> <span class="s">'msg to client '</span> <span class="o">+</span> <span class="n">remote_ip</span>



<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="s">'''
  Our custom request handler who implements a co-routine
  and forwards the calls to an external class instance (core).
  '''</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">webserver</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="n">executor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_core</span> <span class="o">=</span> <span class="n">core</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_webserver</span> <span class="o">=</span> <span class="n">webserver</span>

  <span class="nd">@tornado.gen.coroutine</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
    <span class="s">'''
    This method has to be decorated as a coroutine!
    '''</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>

    <span class="c">#</span>
    <span class="c"># yield is important here</span>
    <span class="c"># and obviously, the executor!</span>
    <span class="c">#</span>
    <span class="c"># we connect the get handler now to the core</span>
    <span class="c">#</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_core</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">remote_ip</span><span class="o">=</span><span class="n">ip</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">WebServer</span><span class="p">:</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8888</span><span class="p">):</span>
    <span class="s">'''
    '''</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>

  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core</span><span class="p">):</span>
    <span class="s">'''
    '''</span>

    <span class="c"># the important part here is the ThreadPoolExecutor being</span>
    <span class="c"># passed to the main handler, as well as an instance of core</span>
    <span class="n">webapp</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="s">r'(/)'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">,</span> <span class="p">{</span><span class="s">'executor'</span><span class="p">:</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                               <span class="s">'core'</span><span class="p">:</span><span class="n">core</span><span class="p">,</span>
                               <span class="s">'webserver'</span><span class="p">:</span><span class="bp">self</span><span class="p">})</span>
    <span class="p">])</span>
    <span class="n">webapp</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>



<span class="c">#</span>
<span class="c"># THE ENTRYPOINT</span>
<span class="c">#</span>
<span class="n">core</span> <span class="o">=</span> <span class="n">Core</span><span class="p">()</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">WebServer</span><span class="p">()</span>
<span class="n">ws</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">core</span><span class="p">)</span>

</code></pre>
</div>

<p>Run the python code and then use the following bash code to simulate multiple parallel requests (via curl, since browsers skip forced multiple requests):</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="k">for </span>V <span class="k">in </span>1 2 3 4 5 6 7 8 9 10 11 12 13
<span class="k">do
  </span>curl -i http://localhost:8888/ &amp;
<span class="k">done</span>
</code></pre>
</div>

<p>Then, tornado will print something along these lines…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
going to sleep 127.0.0.1
done sleeping 127.0.0.1
going to sleep 127.0.0.1
done sleeping 127.0.0.1
going to sleep 127.0.0.1
done sleeping 127.0.0.1
going to sleep 127.0.0.1
done sleeping 127.0.0.1
done sleeping 127.0.0.1done sleeping 127.0.0.1

 done sleeping done sleeping127.0.0.1 
127.0.0.1
done sleeping 127.0.0.1
done sleeping 127.0.0.1
done sleeping 127.0.0.1
done sleeping 127.0.0.1
done sleeping 127.0.0.1
</code></pre>
</div>

<p>…Ten requests ran fully async. Yippee!!</p>

  </div>

  <div class="date">
    Written on February  2, 2017
  </div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          <table>
            <tr>
              <td colspan="2" align="left">da isser ja<br><br></td>
            </tr>
            <tr>
              <td rowspan="2" align="left"><img src="/gfx/danielhaehn.png"/ width="100"></td>
              <td align="left">DANIEL HAEHN<br>machine learning + visualization + connectomics<br>phd student @ harvard</td>
            </tr>
            <tr>
              <td id="icons" align="left">
                <a href="https://twitter.com/danielhaehn" target="_blank"><span class="icon-twitter tooltip"><span class="tooltiptext">Twitter</span></span></a>
                <a href="https://scholar.google.com/citations?user=HGvsO6oAAAAJ&hl=en" target="_blank"><span class="icon-book tooltip"><span class="tooltiptext">Google Scholar</span></span></a>
                <a href="https://www.linkedin.com/in/haehn" target="_blank"><span class="icon-linkedin2 tooltip"><span class="tooltiptext">LinkedIn</span></span></a>
                <a href="https://github.com/haehn" target="_blank"><span class="icon-github tooltip"><span class="tooltiptext">GitHub</span></span></a>
                <a href="mailto:LASTNAME@ieee.org" target="_blank"><span class="icon-email tooltip"><span class="tooltiptext">E-Mail</span></span></a>
              </td>
            </tr>
          </table>
          

        </footer>
      </div>
    </div>

    

  </body>
</html>
